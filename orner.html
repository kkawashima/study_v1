<html>
<head>
  <title>Video chat(orner)</title>
  <!--<link rel="stylesheet" href="style.css">-->
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
  <script src="http://cdn.peerjs.com/0.3/peer.js"></script>
</head>
<body>
  <div>
    <!--audio1部分-->
    <audio id="player1" autoplay></audio>
    <!--audio2部分-->
    <audio id="player2" autoplay></audio>

    <!--guest1へのid-->
    <div id="my-id1"></div>
    <!--guest2へのid-->
    <div id="my-id2"></div>
    <!--guest3へのid-->
    <div id="my-id3"></div>
    <!--guest4へのid-->
    <div id="my-id4"></div>

    <div id="button"></div>

    <p id="speak-to">guest1に話しています。</p>
    <p id="end-call"></p>
    <button id="switch">切り替え</button>

    <button id="set">初期設定</button>
  </div>
</body>
<script>
  // 以下jsの処理
  window.AudioContext = window.AudioContext || window.webkitAudioContext;
  navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;

  // AudioContextのインスタンス作成
  var context = new AudioContext();
  var MAX_DELAY_TIME = 5;
  var delay = context.createDelay(MAX_DELAY_TIME);
  delay.delayTime.value = 3.0;
  //var destination = context.destination;
  var mediastreamdestination1 = context.createMediaStreamDestination();
  var mediastreamdestination2 = context.createMediaStreamDestination();
  var or_audioTrack1 = mediastreamdestination1.stream.getAudioTracks()[0];
  var or_audioTrack2 = mediastreamdestination2.stream.getAudioTracks()[0];
  var hoge1 = null;
  var hoge2 = null;

  var source = null;
  var or_source1 = document.getElementById('player1');
  var or_source2 = document.getElementById('player2');
  var or_stream = null;
  var gu_stream1 = null;
  var gu_stream2 = null;
  var conn3 = null;
  var conn4 = null;
  var flag = 0;
  var medias = {
    audio: true,
    video: false
  };

////////////////////////////////////Peer作成部分/////////////////////////////////////

  // Peer1JSオブジェクト作成
  var peer1 = new Peer(getRandomString(), {
    key: 'nh93y733pow7y14i',
    debug: 3
  });
  // PeerServerとの接続を確立すると指定された内容が実行
  peer1.on('open', function() {
    // idの値を’my-id’idのタグに表示する.
    $('#my-id1').text("guest1との通信id: " +peer1.id);
  });

  // Peer2JSオブジェクト作成
  var peer2 = new Peer(getRandomString(), {
    key: 'nh93y733pow7y14i',
    debug: 3
  });
  // PeerServerとの接続を確立すると指定された内容が実行
  peer2.on('open', function() {
    // idの値を’my-id’idのタグに表示する.
    $('#my-id2').text("guest2との通信id: " +peer2.id);
  });

  // Peer3JSオブジェクト作成
  var peer3 = new Peer(getRandomString(), {
    key: 'nh93y733pow7y14i',
    debug: 3
  });
  // PeerServerとの接続を確立すると指定された内容が実行
  peer3.on('open', function() {
    // idの値を’my-id’idのタグに表示する.
    $('#my-id3').text("guest1とのback通信id: " +peer3.id);
  });

  // Peer4JSオブジェクト作成
  var peer4 = new Peer(getRandomString(), {
    key: 'nh93y733pow7y14i',
    debug: 3
  });
  // PeerServerとの接続を確立すると指定された内容が実行
  peer4.on('open', function() {
    // idの値を’my-id’idのタグに表示する.
    $('#my-id4').text("guest2とのback通信id: " +peer4.id);
  });

//////////////////////////////音声取得部分///////////////////////////////////////

  // orner側の音声をdelayさせて取得
  catch_orner_sound();

/////////////////////////////////接続完了受取部分///////////////////////////////

  // ネットワーク上の他のRemote Peerからの呼び出し(”call”)を受け取ると実行
  peer1.on('call', function(call) {
    $('#my-id1').hide();
    // 接続要求に応答（orner側ののstreamを送る）
    call.answer(mediastreamdestination1.stream);
    // guest側のコールを受信すると発火(guestのstream)
    call.on('stream', function(stream) {
      // guestデータ受信処理
      gu_stream1 = stream;
      hoge1 = gu_stream1.getAudioTracks()[0];
      or_source1.srcObject = gu_stream1;
    });
  });

///////////////////////////////////////////////

  peer2.on('call', function(call) {
    $('#my-id2').hide();
    // 接続要求に応答（orner側ののstreamを送る）
    call.answer(mediastreamdestination2.stream);
    // guest側のコールを受信すると発火(guestのstream)
    call.on('stream', function(stream) {
      // guestデータ受信処理
      gu_stream2 = stream;
      hoge2 = gu_stream2.getAudioTracks()[0];
      or_source2.srcObject = gu_stream2;
    });
  });

/////////////////////////////////////////////////

  peer3.on('connection', function(connection){
    $('#my-id3').hide();
    // データ通信用に connectionオブジェクトを保存しておく
    conn3 = connection;
    // メッセージ受信イベントの設定
    if (conn3 != null) {
      conn3.on("data", function(onRecvMessag){
        if (onRecvMessag == "turn-end") {
          // hogeが会話終了と出るように修正する。切り替えボタンを出す
          $("#end-call").show();
          $("#end-call").text("guest1が会話を終了しました。");
        }
      });
    }
  });

///////////////////////////////////////////////////////

  peer4.on('connection', function(connection){
    $('#my-id4').hide();
    // データ通信用に connectionオブジェクトを保存しておく
    conn4 = connection;
    if (conn4 != null) {
      // メッセージ受信イベントの設定
      conn4.on("data", function(onRecvMessag){
        if (onRecvMessag == "turn-end") {
          // hogeが会話終了と出るように修正する。
          $("#end-call").show();
          $("#end-call").text("guest2が会話を終了しました。");

        }
      });
    }
  });

///////////////////////////////jqueryの処理部分/////////////////////////////

  $(function() {
    // 切り替えの際に実行する(テスト段階)
    $('#switch').click(function() {
      //setInterval(function(){console.log(hoge1,hoge2)}, 500);
      $("#end-call").hide();
      if ( flag == 0 ) {
        $("#speak-to").text("guest2に話しています。");
        // 向こうから来る音をミュートと復活
        hoge1.enabled = false;
        hoge2.enabled = true;
        // 向こうへの音を選別
        or_audioTrack1.enabled = true;
        or_audioTrack2.enabled = false;
        // 向こう側のuiを変更するように送る
        conn3.send("start");
        conn4.send("end");
        flag = 1;
      } else if ( flag == 1 ) {
        $("#speak-to").text("guest1に話しています。");
        // 向こうから来る音をミュートと復活
        hoge1.enabled = true;
        hoge2.enabled = false;
        // 向こうへの音を選別
        or_audioTrack1.enabled = false;
        or_audioTrack2.enabled = true;
        // 向こう側のuiを変更するように送る
        conn3.send("end");
        conn4.send("start");
        flag = 0;
      }
    });

    // 初期設定
    $('#set').click(function() {
      hoge1.enabled = true;
      hoge2.enabled = false;
      or_audioTrack1.enabled = false;
      or_audioTrack2.enabled = true;
      conn3.send("set_active");
      conn4.send("set_static");
      $('#set').hide();
    });
  });

/////////////////////// メソッド部分  /////////////////////////////////

  // Broker IDを短く生成するためのメソッド
  function getRandomString() {
    var BaseString = 'abcdefghijklmnopqrstuvwxyz';
    var randomString = "";
    for (var i = 0; i < 3; i++) {
      randomString += BaseString[Math.floor(Math.random() * BaseString.length)];
    }
    randomString += new Date().getSeconds();
    return randomString;
  }

  // orner側の音声を取得
  function catch_orner_sound() {
    navigator.mediaDevices.getUserMedia(medias)
      .then(function(stream) {
        or_stream = stream;
        delayEffect(or_stream);
      }).catch(function(error) {
        console.log(error);
      });
  }

  // streamにdelayをかける
  function delayEffect(stream) {
    source = context.createMediaStreamSource(stream);
    // delayの情報を付加(メソッド化したい)
    source.connect(delay);
    delay.connect(mediastreamdestination1);
    delay.connect(mediastreamdestination2);
  }

</script>
</html>
