<html>

<head>
  <title>Video chat(guest)</title>
  <!--<link rel="stylesheet" href="style.css">-->
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
  <script src="http://cdn.peerjs.com/0.3/peer.js"></script>
</head>

<body>
  <div>
    <!--audio部分-->
    <audio id="player" autoplay></audio>
    <div>
      <div>
        <div>
          <input type="text" placeholder="Call user id..." id="callto-id" class="peer-input">
          <a href="#" class="peer-input" id="make-call" >Call</a>
        </div>
        <div>
          <input type="text" placeholder="backgroundId..." id="peer-back"  class="back-peer">
          <a href="#"  class="back-peer" id="connect">切り替え</a>
        </div>

        <!-- はじめは隠しておいて接続が完了したら表示する。 -->
        <div>
          <p id="which-turn">相手の番です。</p>
        </div>
        <button id="switch">こちらの番を終了する。</button>


        <!-- テスト音源再生用のソース -->
        <audio id="test" preload="auto">
          <source src="audio.wav" type="audio/wav">
        </audio>
      </div>
    </div>
  </div>
</body>
<script>
  // おまじない↓
  window.AudioContext = window.AudioContext || window.webkitAudioContext;
  navigator.mediaDevices.getUserMedia = navigator.mediaDevices.getUserMedia || navigator.mediaDevices.webkitGetUserMedia || navigator.mediaDevices.mozGetUserMedia;

  //setInterval(function(){console.log(or_stream)}, 500);
  var gu_source = document.getElementById('player');
  var test = document.getElementById("test");
  var or_stream = null;
  var gu_stream = null;
  var conn = null;

  // 取得したい情報を指定
  var medias = {
    audio: true,
    video: false
  };
  // PeerJSオブジェクト作成
  var peer = new Peer(getRandomString(), {
    key: 'nh93y733pow7y14i',
    debug: 3
  });

  // backで動かすようのpeer
  var peer_back = new Peer(getRandomString(), {
    key: 'nh93y733pow7y14i',
    debug: 3
  });

  // guest側の音声を取得
  catch_guest_sound();

  // jquery系まとめ
  $(function() {
    // 通話発信処理(Callをクリックすると発火)
    $('#make-call').click(function() {
      var call = peer.call($('#callto-id').val(), gu_stream);
      if (call != null) {
        // peer-inputを隠す
        $(".peer-input").hide();
        // orner側のコールを受信すると発火(ornerのstream)
        call.on('stream', function(stream) {
          // テスト音源を再生(ここもメソッド化したい)
          test.play();
          // ornerから来たストリームを取得
          gu_source.srcObject = stream;
        });
      }
    });

    // backの接続
   $("#connect").click(function() {
      // 繋がったあとは描画を消す(ボタンの)
      $(".back-peer").hide();
      // 接続先のIDをフォームから取得する
      conn = peer_back.connect($('#peer-back').val());
      if ( conn != null) {
        conn.on("data", function(onRecvMessag){
          if (onRecvMessag == "end") {
            //向こうが話していることがわかるように描画変更
            // 音声再生
            console.log("end");

          } else if (onRecvMessag == "start") {
            //もう話してもいいことがわかるように描画変更
            console.log("start");
            $("#which-turn").text("こちらの番です。");
            $("#switch").show();
          } else if (onRecvMessag == "set_active") {
            $("#which-turn").text("相手の番です。");
            $("#switch").hide();
          } else if (onRecvMessag == "set_static") {
            $("#which-turn").text("こちらの番です。");
            $("#switch").show();
          }
        });
      }
    });
    // こっちの終了を示す  修正　　　　　
    $("#switch").click(function() {
      // クリックしたことを送信
      conn.send("turn-end");
      // 終わったというように描画を変更
      $("#which-turn").text("相手の番です。");
      $("#switch").hide();
      test.play();
    });
  });

/////////////////////// ↓メソッド /////////////////////////////////

  // パスワードとなる文字列を短くするための処理
  function getRandomString() {
    // ランダムな文字列を生成する元の文字列
    var BaseString = 'abcdefghijklmnopqrstuvwxyz';
    var randomString = "";
    for (var i = 0; i < 3; i++) {
      randomString += BaseString[Math.floor(Math.random() * BaseString.length)];
    }
    randomString += new Date().getSeconds();
    console.log(randomString);
    return randomString;
  }

  // guest側の音声を取得
  function catch_guest_sound() {
    navigator.mediaDevices.getUserMedia(medias)
      .then(function(stream) {
        // 一旦格納しないとまずい、理由は本人に
        gu_stream = stream;
      }).catch(function(error) {
        console.log(error);
      });
  }

</script>
</html>
