<html>

<head>
  <title>PeerJS - Video chat example</title>
  <link rel="stylesheet" href="style.css">
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
  <script src="http://cdn.peerjs.com/0.3/peer.js"></script>
</head>

<body>
  <div class="pure-g">
    <!-- Video area -->
    <div class="pure-u-2-3" id="video-container">
      <video id="their-video" autoplay></video>
      <video id="my-video" muted="true" autoplay></video>
    </div>
    <!-- Steps -->
    <div class="pure-u-1-3">
      <h2>PeerJS Video Chat</h2>
      <!-- Get local audio/video stream -->
      <div id="step1">
        <p>Please click `allow` on the top of the screen so we can access your webcam and microphone for calls.</p>
        <div id="step1-error">
          <p>Failed to access the webcam and microphone. Make sure to run this demo on an http server and click allow when asked for permission by the browser.</p>
          <a href="#" class="pure-button pure-button-error" id="step1-retry">Try again</a>
        </div>
      </div>
      <!-- Make calls to others -->
      <div id="step2">
        <p>Your id: <span id="my-id">...</span></p>
        <p>Share this id with others so they can call you.</p>
        <h3>Make a call</h3>
        <div class="pure-form">
          <input type="text" placeholder="Call user id..." id="callto-id">
          <a href="#" class="pure-button pure-button-success" id="make-call">Call</a>
        </div>
      </div>
      <!-- Call in progress -->
      <div id="step3">
        <p>Currently in call with <span id="their-id">...</span></p>
        <p><a href="#" class="pure-button pure-button-error" id="end-call">End call</a></p>
      </div>
    </div>
  </div>
</body>
<script>
  // 以下jsの処理
  let my_video = document.getElementById('my-video');
  let their_video = document.getElementById('their-video');

  navigator.mediaDevices.getUserMedia = navigator.mediaDevices.getUserMedia || navigator.mediaDevices.webkitGetUserMedia || navigator.mediaDevices.mozGetUserMedia;

  // PeerJSオブジェクト作成
  var peer = new Peer(getRandomString(), {
    key: 'nh93y733pow7y14i',
    debug: 3
  });

  // PeerServerとの接続を確立すると指定された内容が実行
  peer.on('open', function() {
    // idの値を’my-id’idのタグに表示する.
    $('#my-id').text(peer.id);
  });

  // ネットワーク上の他のRemote Peerからの呼び出し(”call”)を受け取ると実行
  peer.on('call', function(call) {
    // 受け取った”call”に対しローカルのストリームを返します。
    call.answer(my_video.srcObject);
    step3(call);
  });

  // エラー発生時の処理
  peer.on('error', function(err) {
    alert(err.message);
    step2();
  });

  // ID”make-call”で指定されたタグがクリックされた際の挙動
  $(function() {
    $('#make-call').click(function() {
      // ID”callto-id”で指定されたタグのValueを相手先PeerIDとして取得し、そのIDに対しwindow.localStream(ビデオ、オーディオ等)を”peer.call”で送信する。
      var call = peer.call($('#callto-id').val(),  my_video.srcObject);
      step3(call);
    });

    //ID”end-call”で指定されたタグがクリックされた際の挙動
    //切断ボタンをクリックした場合に、相手との接続を切断します。 call.close()で該当する接続を切断します。発信処理で生成したCallオブジェクトはexistingCallとして保持しておきます。 オブジェクト保持は発信処理のsetupCallEventHandlers()の中で実行します。
    $('#end-call').click(function() {
      // window.existingCall(既存のCall接続情報)を閉じる。
      window.existingCall.close();
      step2();
    });

    // step1-retry”で指定されたタグがクリックされた際の挙動
    $('#step1-retry').click(function() {
      // ID”step1-error”で指定されたタグを非表示
      $('#step1-error').hide();
      step1();
    });
    // Get things started
    step1();
  });

  ////////////////////////↓メソッド郡///////////////////////////
  
  function step1() {
    // オーディオ/ビデオストリームを取得
    navigator.getUserMedia({
      audio: true,
      video: true
    }, function(stream) {
      // Set your video displays
      my_video.srcObject = stream;
      step2();
    }, function() {
      $('#step1-error').show();
    });
  }

  function step2() {
    // ID"step1"、"step3"に該当するタグを非表示にします。
    $('#step1, #step3').hide();
    // 上に類似
    $('#step2').show();
  }

  function step3(call) {
    // ”window.existingCall”が存在するかどうかの確認。存在しない場合は、この処理はスルーされる。
    if (window.existingCall) {
      // 存在する場合は”window.existingCall.close();”により接続が解除
      window.existingCall.close();
    }

    // 相手先のstream(Video,Sound)を受け取った場合にfunction()を実行する。
    call.on('stream', function(stream) {
      // 本来、function()の内容の”prop”はjQueryの関数で、指定した属性に値を設定する処理を行います。ID”#their-video”で指定された<video>タグの”src”属性に上記call.on(“stream”で取得したstream(Video,Sound)からオブジェクトURLを作成して設定します。
      // 上の行の処理をしていたが、うまく動作しないため、変更
      their_video.srcObject = stream;
    });

    // ”call”をwindow.existingCallとして指定。
    window.existingCall = call;
    // $(“#their-id”).textに呼び出し先のcall.peerを書き込んで相手先を表示
    $('#their-id').text(call.peer);
    // ”close”は、接続してる最中に接続が解除された場合の処理。
    call.on('close', step2);
    $('#step1, #step2').hide();
    $('#step3').show();
  }

  // Broker IDを短く生成するためのメソッド
  function getRandomString() {
    // ランダムな文字列を生成する元の文字列
    var BaseString = 'abcdefghijklmnopqrstuvwxyz';
    var randomString = "";
    for (var i = 0; i < 3; i++) {
      randomString += BaseString[Math.floor(Math.random() * BaseString.length)];
    }
    randomString += new Date().getSeconds();
    return randomString;
  }

  ///////////////////////////↑メソッド郡/////////////////////////
</script>

</html>
